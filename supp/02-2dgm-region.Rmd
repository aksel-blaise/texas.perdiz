# Natural regions

```{r load, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
library(here)
library(StereoMorph)
library(geomorph)
library(wesanderson)
library(ggplot2)
```

## Read data and define sLMs

```{r read, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
shapes <- readShapes("shapes")
shapesGM <- readland.shapes(shapes, nCurvePts = c(10, 10, 10, 10))
```

## Read qualitative data

```{r read qual, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
qdata <- read.csv("qdata.csv",
                  header = TRUE,
                  row.names = 1)
```

## Generalised Procrustes Analysis

Landmark data were aligned to a global coordinate system [@RN11622;@RN11623;@RN11563], achieved through generalised Procrustes superimposition [@RN478] performed in R 4.0.4 [@R] using the `geomorph` library v. 3.3.2 [@RN11530;@RN1774]. Procrustes superimposition translates, scales, and rotates the coordinate data to allow for comparisons among objects [@RN11564;@RN478]. The `geomorph` package uses a partial Procrustes superimposition that projects the aligned specimens into tangent space subsequent to alignment in preparation for the use of multivariate methods that assume linear space [@RN1646;@RN11563]. 

```{r gp, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
Y.gpa <- gpagen(shapesGM, print.progress = FALSE)
plot(Y.gpa)

# dataframe
gdf <- geomorph.data.frame(shape = Y.gpa$coords,
                            size = Y.gpa$Csize,
                            region = qdata$region)

# add centroid size to qdata
qdata$csz <- Y.gpa$Csize

# revised table of attributes
knitr::kable(qdata,
             align = "lccc",
             caption = "Attributes of Perdiz arrow points included in the sample.")
```

## Boxplot

```{r box, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
# attributes
csz <- qdata$csz
region <- qdata$region

# palette
pal = wes_palette("Darjeeling1", 5, type = "continuous")

# boxplot of Perdiz arrow points by region
csz.reg <- ggplot(qdata, aes(x = region, y = csz, color = region)) +
  geom_boxplot() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 0.3) +
  scale_color_manual(values = pal) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = 'Region', y = 'Centroid Size')
  
# render plot
csz.reg
```

## Principal Components Analysis

Principal components analysis [@RN1746] was used to visualise shape variation among the bottles. The shape changes described by each principal axis are commonly visualised using thin-plate spline warping of a reference 3D mesh [@RN1731;@RN479]. 

```{r pc, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
# pca
pca <- gm.prcomp(Y.gpa$coords)
summary(pca)

# set plot parameters
pch.gps <- c(3,15:18)[as.factor(region)]
col.gps <- pal[as.factor(region)]
col.hull <- c("#FF0000","#00A08A","#F98400","#5BBCD6","#F2AD00")

# pca plot
pc.plot <- plot(pca,
                asp = 1,
                pch = pch.gps,
                col = col.gps)
shapeHulls(pc.plot,
           groups = region,
           group.cols = col.hull)
```

## Procrustes ANOVA - allometry

A residual randomisation permutation procedure (RRPP; n = 10,000 permutations) was used for all Procrustes ANOVAs [@RN1655;@RN11775], which has higher statistical power and a greater ability to identify patterns in the data should they be present [@RN1719]. To assess whether shape changes differ by group (geography and time), Procrustes ANOVAs [@RN1749] were also run that enlist effect-sizes (zscores) computed as standard deviates of the generated sampling distributions [@RN1756].

```{r anova.allom, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
# general allometry
fit.size <- procD.lm(shape ~ size,
                     data = gdf,
                     print.progress = FALSE,
                     iter = 9999)

# general allometry?
anova(fit.size)
```

## Procrustes ANOVA - shape and size

A residual randomisation permutation procedure (RRPP; n = 10,000 permutations) was used for all Procrustes ANOVAs [@RN1655;@RN11775], which has higher statistical power and a greater ability to identify patterns in the data should they be present [@RN1719]. To assess whether shape changes differ by group (geography and time), Procrustes ANOVAs [@RN1749] were also run that enlist effect-sizes (zscores) computed as standard deviates of the generated sampling distributions [@RN1756].

```{r shape.size, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
# size as a function of natural region?
fit.sz.reg <- procD.lm(size ~ region,
                       data = gdf,
                       print.progress = FALSE,
                       iter = 9999)

# size
anova(fit.sz.reg)

# shape as a function of natural region?
fit.sh.reg <- procD.lm(shape ~ region,
                       data = gdf,
                       print.progress = FALSE,
                       iter = 9999)

# shape
anova(fit.sh.reg)
```

## Morphological integration

```{r morph.integ, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
land.gps <- c("A","A","B","A","A","A","A","A","A","A","A","A","B","B","B","B",
              "B","B","B","B","B","B","B","B","B","B","B","B","A","A","A","A",
              "A","A","A","A")
it <- integration.test(Y.gpa$coords,
                       partition.gp = land.gps,
                       iter = 9999,
                       print.progress = FALSE)

summary(it)
plot(it)
```

## Morphological disparity

```{r morph.disp, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
morphol.disparity(shape ~ region,
                  groups = qdata$region,
                  data = gdf,
                  print.progress = FALSE,
                  iter = 9999)
```

## Mean shapes

```{r mshape, out.width = "100%", dpi = 300, echo = TRUE, warning=FALSE}
# subset landmark coordinates to produce mean shapes
new.coords <- coords.subset(A = Y.gpa$coords,
                            group = qdata$region)
names(new.coords)

# group shape means
mean <- lapply(new.coords, mshape)

# plot mean shapes
plot(mean$`blackland prairies`) 
plot(mean$`edwards plateau`)
plot(mean$`gulf coast prairies and marshes`)
plot(mean$`oak woods and parairies`)
plot(mean$`piney woods`)

# comparison plots
plotRefToTarget(mean$`blackland prairies`,
                mean$`edwards plateau`,
                method = "points",
                mag = 1)


plotRefToTarget(mean$`blackland prairies`, 
                mean$`gulf coast prairies and marshes`,
                method = "points", 
                mag = 1)


plotRefToTarget(mean$`blackland prairies`, 
                mean$`oak woods and parairies`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`blackland prairies`, 
                mean$`piney woods`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`edwards plateau`, 
                mean$`gulf coast prairies and marshes`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`edwards plateau`, 
                mean$`oak woods and parairies`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`edwards plateau`, 
                mean$`piney woods`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`gulf coast prairies and marshes`,
                mean$`oak woods and parairies`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`gulf coast prairies and marshes`, 
                mean$`piney woods`, 
                method = "points",
                mag = 1)


plotRefToTarget(mean$`oak woods and parairies`, 
                mean$`piney woods`, 
                method = "points",
                mag = 1)
```
